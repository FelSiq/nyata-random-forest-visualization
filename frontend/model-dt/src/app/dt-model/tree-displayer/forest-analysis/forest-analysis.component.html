<mat-accordion>
  <mat-expansion-panel>
    <mat-expansion-panel-header
          matTooltip="Generate the most frequent attribute sequences for all possible paths in the forest model.">
      <mat-panel-title>
        <mat-icon class="panel-option-icon">sort</mat-icon>
        Rank most common attribute sequences
      </mat-panel-title>
    </mat-expansion-panel-header>

    <ng-template matExpansionPanelContent>
      <mat-card>
        <mat-card-content>
          <p>
            Generate the most frequent attribute sequences from all possible paths (from each tree root to every tree leaf) in the forest model.
          </p>
          <p>
            <strong>Each path is weighted by the number of training instances that pass through it.</strong>
          </p>
          <p>
            Please select the number of sequences to show after analysis:
          </p>
          <mat-form-field appearance="outline" id="numAttrInput">
            <input matInput #numAttr type="number" value="10" min="1"/>
          </mat-form-field>
          <div *ngIf="calledCommonAttrSeqService || (rankCommonAttrSeq && rankCommonAttrSeq.length)">
            <div><strong>Results:</strong></div>
            <div> Total of combinations obtained: {{ attrSeqRelFreq.length }} </div>
            <div> Total of weighted combination frequency captured: {{ 100 * totalRelFreq | number: '.2-2'}}% </div>
            <ng-container *ngIf="rankCommonAttrSeq && rankCommonAttrSeq.length; else waitingForCommonAttrSeq">
              <mat-list>
                <mat-list-item>
                  <span class="common-attr-table-rank"><strong>Rank</strong></span>
                  <span class="common-attr-table-left-bar"><strong>Frequency</strong></span>
                  <span class="common-attr-table-right"><strong>Attribute indices sequences</strong></span>
                </mat-list-item>
                <mat-list-item *ngFor="let seq of rankCommonAttrSeq; index as i">
                  <span class="common-attr-table-rank"> {{ i + 1 }} </span>
                  <mat-progress-bar class="common-attr-table-bar" [mode]="determinate" [value]="100 * attrSeqRelFreq[i]"></mat-progress-bar>
                  <span class="common-attr-table-left"> {{ 100 * attrSeqRelFreq[i] | number:'.2-2' }}% </span>
                  <span class="common-attr-table-right">{{ seq }} </span>
                </mat-list-item>
              </mat-list>
            </ng-container>
            <ng-template #waitingForCommonAttrSeq>
              <mat-spinner style="margin:0 auto;"></mat-spinner>
            </ng-template>
          </div>
        </mat-card-content>
        <mat-card-actions align="end">
          <button mat-raised-button [disabled]="(+numAttr.value) < 1" color="primary" (click)="getMostCommonAttrSeq(+numAttr.value)">
            Run
          </button>
        </mat-card-actions>
      </mat-card>
    </ng-template>
  </mat-expansion-panel>

  <mat-expansion-panel>
    <mat-expansion-panel-header
          matTooltip="">
      <mat-panel-title>
        <mat-icon class="panel-option-icon">account_tree</mat-icon>
        Forest hierarchical clustering
      </mat-panel-title>
    </mat-expansion-panel-header>

    <ng-template matExpansionPanelContent>
      <mat-card>
        <mat-card-content>
          <p>
            Perform a hierarchical clustering to agglomerate the most common trees.
          </p>
          <p>
            The clustering is performed using the median linkage and the Cohen's Kappa score as a distance
            measure between the DNA vectors of every tree. The DNA vector of a tree is the predictions of
            the tree for every instance.
          </p>
          <p>
            The user may choose to upload a dataset to build the DNA vectors, or else a random dataset will
            be generated using a uniform distribution for every attribute, within the maximum and minimum
            values for each attribute.
          </p>
	  <p *ngIf="numEstimators <= 1; else hierClusInputContainer">
	    <mat-icon style="vertical-align: middle; margin-right: 8px; font-size: 150%;">error</mat-icon>
	    <strong style="style=vertical-align: middle;">It is necessary a forest to run this analysis.</strong>
          </p>
          <ng-template #hierClusInputContainer>
	    <p>
	      Please select the proportion of similarity of cut the dendrogram distances.
            </p>
	    <mat-list dense>
	      <mat-list-item> Proportion = 0.0 means every tree will be in a distinct cluster. </mat-list-item> 
	      <mat-list-item> Proportion = 1.0 means every tree will be in the same cluster. </mat-list-item> 
            </mat-list>
	    <mat-slider #propCutSlider min="0.0" max="1.0" step="0.01" [(value)]="propCutSliderValue" color="primary" style="width: 80%; margin-left: 8px;"></mat-slider>
	    Value: {{ propCutSlider.value | number: '1.2-2'}}
	  </ng-template>
	  <div *ngIf="calledHirClusService || (hierClusters && hierClusters.length)">
            <div *ngIf="hierClusters && hierClusters.length; else waitingForHierClus">
	      <strong> Results: </strong>
	      {{ hierClusters }}
            </div>
            <ng-template #waitingForHierClus>
              <mat-spinner style="margin:0 auto;"></mat-spinner>
            </ng-template>
	  </div>
        </mat-card-content>
        <mat-card-actions align="end">
	    <button [disabled]="numEstimators <= 1"
		    mat-raised-button
	            [matTooltip]="numEstimators <= 1 ? 'It is necessary a forest to run this analysis' : ''" 
		    color="primary"
		    (click)="getHierarchicalClustering(+propCutSliderValue)">
            Run
          </button>
        </mat-card-actions>
      </mat-card>
    </ng-template>
  </mat-expansion-panel>
</mat-accordion>
